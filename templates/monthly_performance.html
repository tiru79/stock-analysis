{% extends "base.html" %}
{% block title %}Monthly returns{% if result.year %} {{ result.year }}{% elif result.since %} since {{ result.since }}{% endif %} – Financial Markets{% endblock %}
{% block content %}
  <h2>Monthly returns</h2>
  <p style="color: var(--muted); margin-bottom: 1rem;">Enter one or more symbols and either a <strong>year</strong> (single year) or <strong>since</strong> (from that year to latest). Table shows monthly return % and full-year return.</p>

  <form method="get" action="{{ url_for('monthly_performance') }}" class="monthly-perf-form" style="margin-bottom: 1.5rem;">
    <div style="display: flex; flex-wrap: wrap; align-items: flex-end; gap: 1rem;">
      <div>
        <label for="symbols" style="display: block; margin-bottom: 0.35rem; font-size: 0.9rem;">Symbols</label>
        <input
          type="text"
          id="symbols"
          name="symbols"
          value="{{ symbols_param|default('', true) }}"
          placeholder="e.g. QQQ, SPY, SLV, GLD, SMH, SOXX"
          style="width: 220px; padding: 0.6rem 0.75rem; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--text);"
          autofocus
        />
      </div>
      <div>
        <label for="year" style="display: block; margin-bottom: 0.35rem; font-size: 0.9rem;">Year (single year)</label>
        <input
          type="number"
          id="year"
          name="year"
          value="{{ year_param|default('', true) }}"
          placeholder="e.g. 2024"
          min="1990"
          max="2100"
          style="width: 110px; padding: 0.6rem 0.75rem; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--text);"
        />
      </div>
      <div>
        <label for="since" style="display: block; margin-bottom: 0.35rem; font-size: 0.9rem;">Since (from year)</label>
        <input
          type="number"
          id="since"
          name="since"
          value="{{ since_param|default('', true) }}"
          placeholder="e.g. 2016"
          min="1990"
          max="2100"
          style="width: 110px; padding: 0.6rem 0.75rem; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--text);"
        />
      </div>
      <button type="submit" style="padding: 0.6rem 1.2rem; font-size: 0.95rem; border-radius: 8px; border: none; background: var(--accent); color: var(--bg); font-weight: 600; cursor: pointer;">
        Show
      </button>
    </div>
  </form>

  {% if result and result.missing %}
    <p style="font-size: 0.85rem; color: var(--muted); margin-bottom: 0.75rem;">No data for: {{ result.missing | join(", ") }}</p>
  {% endif %}

  {% if result and result.mode == 'year' and result.year %}
    <h3 style="font-size: 1rem; margin: 1rem 0 0.75rem;">Monthly returns {{ result.year }} (%)</h3>
    <p style="font-size: 0.85rem; color: var(--muted); margin-bottom: 0.75rem;">Each cell: price at start of month and that month’s return %. Year % = full calendar year; $10K = value of $10,000 invested Jan 1. <span style="background: rgba(34, 197, 94, 0.5); padding: 1px 6px; border-radius: 4px;">green</span> = positive, <span style="background: rgba(239, 68, 68, 0.5); padding: 1px 6px; border-radius: 4px;">red</span> = negative. Hover over major drawdowns (month ≤−5%, year ≤−10%) for a note.</p>
    <div class="table-wrap" style="overflow-x: auto; border: 1px solid var(--border); border-radius: 10px; background: var(--surface); margin-bottom: 2rem;">
      <table class="monthly-table" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); position: sticky; left: 0; background: var(--surface);">Symbol</th>
            {% for name in month_names %}
              <th style="text-align: right; padding: 0.75rem; border-bottom: 1px solid var(--border); white-space: nowrap;">{{ name }}</th>
            {% endfor %}
            <th style="text-align: right; padding: 0.75rem; border-bottom: 1px solid var(--border);">Year %</th>
            <th style="text-align: right; padding: 0.75rem; border-bottom: 1px solid var(--border);">$10K</th>
          </tr>
        </thead>
        <tbody>
          {% for r in result.rows %}
            {% if r.months %}
              <tr>
                <td style="padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); position: sticky; left: 0; background: var(--surface);">
                  <a href="{{ r.yahoo_url }}" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none;">{{ r.symbol }}</a>
                </td>
                {% for i in range(1, 13) %}
                  {% set val = r.months[i] %}
                  {% set month_name = month_names[i-1] %}
                  {% set sp = r.months.start_prices[i] | default(none) %}
                  <td class="heatmap-cell" style="text-align: right; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace;{% if val is not none %}{% if val > 0 %} background: rgba(34, 197, 94, {{ (0.2 + 0.5 * [1, val/15]|min)|round(2) }});{% elif val < 0 %} background: rgba(239, 68, 68, {{ (0.2 + 0.5 * [1, (val|abs)/15]|min)|round(2) }});{% endif %}{% endif %}"{% if val is not none and val <= -5 %} title="Major drawdown: {{ "%.2f" | format(val) }}% ({{ month_name }} {{ result.year }})"{% endif %}>
                    {% if sp is not none %}<div style="font-size: 0.75em; color: var(--muted);">${{ "%.2f" | format(sp) }}</div>{% endif %}
                    {% if val is not none %}{{ "%.2f" | format(val) }}%{% else %}—{% endif %}
                  </td>
                {% endfor %}
                {% set yp = r.months.year_pct %}
                <td class="heatmap-cell" style="text-align: right; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace;{% if yp is not none %}{% if yp > 0 %} background: rgba(34, 197, 94, {{ (0.2 + 0.5 * [1, yp/15]|min)|round(2) }});{% elif yp < 0 %} background: rgba(239, 68, 68, {{ (0.2 + 0.5 * [1, (yp|abs)/15]|min)|round(2) }});{% endif %}{% endif %}"{% if yp is not none and yp <= -10 %} title="Major drawdown: {{ "%.1f" | format(yp) }}% (full year {{ result.year }})"{% endif %}>
                  {% if yp is not none %}{{ "%.1f" | format(yp) }}%{% else %}—{% endif %}
                </td>
                <td style="text-align: right; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace;">{{ r.months.growth_10k|default('—', true) }}</td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}

  {% if result and result.mode == 'since' and result.since %}
    <h3 style="font-size: 1rem; margin: 1rem 0 0.75rem;">Monthly returns since {{ result.since }}</h3>
    <p style="font-size: 0.85rem; color: var(--muted); margin-bottom: 0.75rem;">Each cell: price at start of month and that month’s return %. Year % = full calendar year; $10K = value at end of year from $10K at start of that year. <span style="background: rgba(34, 197, 94, 0.5); padding: 1px 6px; border-radius: 4px;">green</span> = positive, <span style="background: rgba(239, 68, 68, 0.5); padding: 1px 6px; border-radius: 4px;">red</span> = negative. Hover over major drawdowns (month ≤−5%, year ≤−10%) for a note.</p>
    {% for r in result.rows %}
      {% if r.years %}
        <h4 style="font-size: 0.95rem; margin: 1.25rem 0 0.5rem;"><a href="{{ r.yahoo_url }}" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none;">{{ r.symbol }}</a></h4>
        <div class="table-wrap" style="overflow-x: auto; border: 1px solid var(--border); border-radius: 10px; background: var(--surface); margin-bottom: 1.5rem;">
          <table class="monthly-table" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
            <thead>
              <tr>
                <th style="text-align: left; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border);">Year</th>
                {% for name in month_names %}
                  <th style="text-align: right; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); white-space: nowrap;">{{ name }}</th>
                {% endfor %}
                <th style="text-align: right; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border);">Year %</th>
                <th style="text-align: right; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border);">$10K</th>
              </tr>
            </thead>
            <tbody>
              {% for yr in r.years %}
                <tr>
                  <td style="padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border);">{{ yr.year }}</td>
                  {% for i in range(1, 13) %}
                    {% set val = yr.months[i] %}
                    {% set month_name = month_names[i-1] %}
                    {% set sp = yr.start_prices[i] | default(none) %}
                    <td class="heatmap-cell" style="text-align: right; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace;{% if val is not none %}{% if val > 0 %} background: rgba(34, 197, 94, {{ (0.2 + 0.5 * [1, val/15]|min)|round(2) }});{% elif val < 0 %} background: rgba(239, 68, 68, {{ (0.2 + 0.5 * [1, (val|abs)/15]|min)|round(2) }});{% endif %}{% endif %}"{% if val is not none and val <= -5 %} title="Major drawdown: {{ "%.2f" | format(val) }}% ({{ month_name }} {{ yr.year }})"{% endif %}>
                      {% if sp is not none %}<div style="font-size: 0.75em; color: var(--muted);">${{ "%.2f" | format(sp) }}</div>{% endif %}
                      {% if val is not none %}{{ "%.2f" | format(val) }}%{% else %}—{% endif %}
                    </td>
                  {% endfor %}
                  {% set yp = yr.year_pct %}
                  <td class="heatmap-cell" style="text-align: right; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace;{% if yp > 0 %} background: rgba(34, 197, 94, {{ (0.2 + 0.5 * [1, yp/15]|min)|round(2) }});{% elif yp < 0 %} background: rgba(239, 68, 68, {{ (0.2 + 0.5 * [1, (yp|abs)/15]|min)|round(2) }});{% endif %}"{% if yp <= -10 %} title="Major drawdown: {{ "%.1f" | format(yp) }}% (full year {{ yr.year }})"{% endif %}>
                    {{ "%.1f" | format(yp) }}%
                  </td>
                  <td style="text-align: right; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace;">{{ yr.growth_10k }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if result and result.rows and not result.mode %}
    <p style="color: var(--muted);">Enter a <strong>year</strong> (e.g. 2024) for one year, or <strong>since</strong> (e.g. 2016) for multiple years, then click Show.</p>
  {% endif %}
{% endblock %}
{% block extra_css %}
  .monthly-table tbody tr:hover { background: rgba(34, 197, 94, 0.06); }
  .monthly-perf-form input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.25); }
  /* Heatmap: green = positive, red = negative (intensity from inline alpha) */
  .heatmap-cell { color: var(--text); }
  .heatmap-cell[title] { cursor: help; }
  .monthly-table .heatmap-cell:empty::before { content: "—"; color: var(--muted); }
{% endblock %}
