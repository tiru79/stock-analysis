{% extends "base.html" %}
{% block title %}Upcoming earnings – {{ index_param|default('NASDAQ100') }}{% endblock %}
{% block content %}
  <h2>Upcoming earnings calendar</h2>
  <p style="color: var(--muted); margin-bottom: 1rem;">View upcoming earnings by week for NASDAQ100 or enter specific symbol(s). Data via Yahoo Finance.</p>

  <form method="get" action="{{ url_for('calendar') }}" class="calendar-form" style="margin-bottom: 1.5rem;">
    <div style="display: flex; flex-wrap: wrap; align-items: flex-end; gap: 1rem;">
      <div>
        <label for="index" style="display: block; margin-bottom: 0.35rem; font-size: 0.9rem;">Index</label>
        <select name="index" id="index" style="padding: 0.6rem 0.75rem; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--text); min-width: 140px;">
          {% for idx in indices %}
            <option value="{{ idx }}" {% if index_param == idx %}selected{% endif %}>{{ idx }}</option>
          {% endfor %}
          {% if not indices %}
            <option value="NASDAQ100" {% if index_param == 'NASDAQ100' %}selected{% endif %}>NASDAQ100</option>
          {% endif %}
        </select>
      </div>
      <div>
        <label for="symbol" style="display: block; margin-bottom: 0.35rem; font-size: 0.9rem;">Symbol (optional)</label>
        <input type="text" id="symbol" name="symbol" value="{{ symbol_param|default('', true) }}"
          placeholder="e.g. AAPL or AAPL, MSFT"
          style="width: 180px; padding: 0.6rem 0.75rem; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--text);" />
      </div>
      <div>
        <label for="weeks" style="display: block; margin-bottom: 0.35rem; font-size: 0.9rem;">Weeks ahead</label>
        <input type="number" id="weeks" name="weeks" value="{{ weeks_ahead|default(6, true) }}" min="1" max="12"
          style="width: 70px; padding: 0.6rem 0.75rem; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--text);" />
      </div>
      <button type="submit" style="padding: 0.6rem 1.2rem; font-size: 0.95rem; border-radius: 8px; border: none; background: var(--accent); color: var(--bg); font-weight: 600; cursor: pointer;">Show</button>
    </div>
  </form>

  {% if not yfinance_available %}
    <p style="color: #f59e0b;">yfinance is not installed. Install with: <code style="background: var(--surface); padding: 2px 6px;">pip install yfinance</code></p>
  {% elif by_week %}
    <p style="font-size: 0.85rem; color: var(--muted); margin-bottom: 0.75rem;">
      Week of Monday · Earnings dates (next {{ weeks_ahead }} weeks).
      {% if calendar_symbol_cap and calendar_symbol_total and calendar_symbol_total > calendar_symbol_cap %}
        Showing first {{ calendar_symbol_cap }} of {{ calendar_symbol_total }} index symbols to avoid rate limits. Enter symbol(s) to see specific tickers.
      {% else %}
        Leave symbol empty to use index symbols.
      {% endif %}
    </p>
    <div class="calendar-weeks" style="display: flex; flex-direction: column; gap: 1rem;">
      {% for week in by_week %}
        <div style="border: 1px solid var(--border); border-radius: 10px; background: var(--surface); overflow: hidden;">
          <div style="padding: 0.6rem 1rem; border-bottom: 1px solid var(--border); font-weight: 600;">Week of {{ week.week_label }}</div>
          <div style="padding: 0.75rem 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem 1rem;">
            {% for ev in week.events %}
              <a href="https://finance.yahoo.com/quote/{{ ev.symbol }}" target="_blank" rel="noopener" style="display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.6rem; background: var(--bg); border-radius: 6px; color: var(--accent); text-decoration: none; font-size: 0.9rem;">
                <span>{{ ev.symbol }}</span>
                <span style="color: var(--muted); font-size: 0.85em;">{{ ev.date_label }}</span>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% elif symbol_param or index_param %}
    <p style="color: var(--muted);">No upcoming earnings dates found for the next {{ weeks_ahead }} weeks. Try more weeks or another index/symbol.</p>
  {% endif %}
{% endblock %}
{% block extra_css %}
  .calendar-form input:focus, .calendar-form select:focus { outline: none; border-color: var(--accent); }
{% endblock %}
